<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Scanner - Boutique Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .main-card { 
            border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: white;
        }
        .scanner-input {
            border-radius: 15px;
            border: 3px solid #28a745;
            padding: 20px;
            font-size: 18px;
            text-align: center;
        }
        .scanner-input:focus {
            border-color: #20c997;
            box-shadow: 0 0 0 0.2rem rgba(40,167,69,0.25);
        }
        .camera-view {
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            min-height: 300px;
            position: relative;
        }
        .camera-view canvas, .camera-view video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
        .result-card {
            border-radius: 10px;
            margin-top: 15px;
        }
        .btn-scanner {
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-warning">
        <div class="container">
            <span class="navbar-brand">üì± Scanner Mobile</span>
            <a href="/" class="btn btn-light btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Retour
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- Scanner manuel -->
                <div class="main-card p-4 mb-4">
                    <h5><i class="bi bi-upc-scan me-2"></i>Scanner Manuel</h5>
                    <div class="mb-3">
                        <input type="text" class="form-control scanner-input" 
                               id="codeInput" 
                               placeholder="Scannez ou tapez le code-barres..."
                               autofocus>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-success btn-scanner" onclick="scanner()">
                            <i class="bi bi-search me-2"></i>Rechercher et D√©cr√©menter (-1)
                        </button>
                    </div>
                </div>

                <!-- Scanner cam√©ra -->
                <div class="main-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="bi bi-camera me-2"></i>Scanner Cam√©ra</h5>
                        <div>
                            <button id="startCamera" class="btn btn-success btn-sm me-2">
                                <i class="bi bi-play me-1"></i>D√©marrer
                            </button>
                            <button id="stopCamera" class="btn btn-danger btn-sm" style="display: none;">
                                <i class="bi bi-stop me-1"></i>Arr√™ter
                            </button>
                        </div>
                    </div>
                    <div id="cameraContainer" style="display: none;">
                        <div id="interactive" class="camera-view"></div>
                        <div class="text-center mt-3">
                            <div class="alert alert-info">
                                <strong>üì∑ Scanner actif</strong><br>
                                Pointez vers un code-barres
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R√©sultats -->
                <div id="resultats"></div>

                <!-- Instructions -->
                <div class="main-card p-4">
                    <h6><i class="bi bi-info-circle me-2"></i>Instructions</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>üîç Scanner Manuel</strong>
                            <ul class="small mt-2">
                                <li>Utilisez une douchette USB/Bluetooth</li>
                                <li>Ou tapez le code manuellement</li>
                                <li>Appuyez Entr√©e pour scanner</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>üì∑ Scanner Cam√©ra</strong>
                            <ul class="small mt-2">
                                <li>Autorisez l'acc√®s √† la cam√©ra</li>
                                <li>Pointez vers le code-barres</li>
                                <li>Scan automatique d√®s d√©tection</li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-success mt-3">
                        <strong>‚ö° Action automatique :</strong> 
                        Chaque scan retire 1 unit√© du stock imm√©diatement
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isScanning = false;
        let lastCode = '';
        let lastTime = 0;

        // Scanner manuel
        document.getElementById('codeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scanner();
            }
        });

        function scanner() {
            const code = document.getElementById('codeInput').value.trim();
            if (!code) return;
            
            const currentTime = Date.now();
            if (code === lastCode && currentTime - lastTime < 2000) {
                return; // √âviter les doublons
            }
            
            lastCode = code;
            lastTime = currentTime;
            
            fetch('/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code: code})
            })
            .then(response => response.json())
            .then(data => {
                afficherResultat(data);
                document.getElementById('codeInput').value = '';
                document.getElementById('codeInput').focus();
            })
            .catch(error => {
                afficherResultat({success: false, message: 'Erreur de connexion'});
            });
        }

        function afficherResultat(data) {
            const resultats = document.getElementById('resultats');
            const alertClass = data.success ? 'alert-success' : 'alert-danger';
            const icon = data.success ? 'bi-check-circle' : 'bi-x-circle';
            
            resultats.innerHTML = `
                <div class="result-card alert ${alertClass} alert-dismissible fade show">
                    <i class="bi ${icon} me-2"></i>
                    <strong>${data.message}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Auto-masquer apr√®s 4 secondes si succ√®s
            if (data.success) {
                setTimeout(() => {
                    const alert = resultats.querySelector('.alert');
                    if (alert) {
                        alert.classList.remove('show');
                        setTimeout(() => alert.remove(), 150);
                    }
                }, 4000);
            }
        }

        // Scanner cam√©ra
        document.getElementById('startCamera').addEventListener('click', function() {
            if (isScanning) return;

            document.getElementById('cameraContainer').style.display = 'block';
            document.getElementById('startCamera').style.display = 'none';
            document.getElementById('stopCamera').style.display = 'inline-block';
            isScanning = true;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 10,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader", 
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Erreur cam√©ra:', err);
                    afficherResultat({success: false, message: 'Erreur cam√©ra: ' + err.message});
                    stopCamera();
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                
                // Scanner avec la m√™me logique que le manuel
                fetch('/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: code})
                })
                .then(response => response.json())
                .then(result => {
                    afficherResultat(result);
                    
                    // Pause de 2 secondes avant de reprendre
                    Quagga.stop();
                    setTimeout(() => {
                        if (isScanning) {
                            Quagga.start();
                        }
                    }, 2000);
                })
                .catch(error => {
                    afficherResultat({success: false, message: 'Erreur de connexion'});
                });
            });
        });

        document.getElementById('stopCamera').addEventListener('click', stopCamera);

        function stopCamera() {
            if (!isScanning) return;

            Quagga.stop();
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('startCamera').style.display = 'inline-block';
            document.getElementById('stopCamera').style.display = 'none';
            isScanning = false;
        }

        // Raccourcis clavier
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                stopCamera();
            }
        });
    </script>
</body>
</html>
