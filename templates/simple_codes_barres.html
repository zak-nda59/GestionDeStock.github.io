<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∑Ô∏è Codes-barres - Mobile Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        * { font-family: 'Poppins', sans-serif; }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .barcode-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }
        
        .barcode-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .barcode-canvas {
            max-width: 100%;
            height: auto;
        }
        
        .print-section {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            page-break-inside: avoid;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 25px;
            padding: 8px 20px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        
        .size-control {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            .print-section { 
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                margin: 5px !important;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg no-print" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
        <div class="container">
            <span class="navbar-brand text-white fw-bold">üè∑Ô∏è G√©n√©rateur Codes-barres</span>
            <a href="/" class="btn btn-light btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Retour
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Contr√¥les -->
        <div class="glass-card p-4 mb-4 no-print">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="text-white mb-3">üéõÔ∏è Filtres</h5>
                    <button class="filter-btn active" onclick="filterCategory('all')">Tous</button>
                    {% for cat in categories %}
                    <button class="filter-btn" onclick="filterCategory('{{ cat.nom }}')">
                        {{ cat.emoji }} {{ cat.nom }}
                    </button>
                    {% endfor %}
                </div>
                <div class="col-md-6">
                    <div class="size-control">
                        <label class="form-label fw-bold">üìè Taille des codes-barres</label>
                        <input type="range" class="form-range" id="sizeSlider" 
                               min="0.5" max="2" step="0.1" value="1" 
                               oninput="updateBarcodeSize(this.value)">
                        <div class="d-flex justify-content-between">
                            <small>Petit</small>
                            <small>Normal</small>
                            <small>Grand</small>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex">
                        <button class="btn btn-success" onclick="selectAll()">
                            <i class="bi bi-check-all me-1"></i>Tout s√©lectionner
                        </button>
                        <button class="btn btn-warning" onclick="printSelected()">
                            <i class="bi bi-printer me-1"></i>Imprimer s√©lection
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Codes-barres -->
        {% if produits %}
        <div id="barcodesContainer">
            {% for produit in produits %}
            <div class="barcode-item" data-category="{{ produit.categorie }}">
                <div class="row align-items-center">
                    <div class="col-md-1">
                        <input type="checkbox" class="form-check-input barcode-checkbox" 
                               value="{{ produit.id }}" style="transform: scale(1.5);">
                    </div>
                    <div class="col-md-5">
                        <div class="d-flex align-items-center mb-2">
                            {% for cat in categories %}
                                {% if cat.nom == produit.categorie %}
                                    <span class="fs-4 me-2">{{ cat.emoji }}</span>
                                {% endif %}
                            {% endfor %}
                            <div>
                                <h6 class="mb-0 fw-bold">{{ produit.nom }}</h6>
                                <small class="text-muted">{{ produit.categorie }}</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-primary">{{ produit.code_barres }}</span>
                            <span class="badge bg-success">{{ "%.2f"|format(produit.prix) }}‚Ç¨</span>
                            <span class="badge 
                                {% if produit.stock == 0 %}bg-danger
                                {% elif produit.stock <= 5 %}bg-warning
                                {% else %}bg-info{% endif %}">
                                Stock: {{ produit.stock }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6 text-center">
                        <canvas class="barcode-canvas" 
                                data-code="{{ produit.code_barres }}"
                                data-text="{{ produit.nom }}"></canvas>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="glass-card p-5 text-center">
            <i class="bi bi-inbox display-1 text-white opacity-50"></i>
            <h4 class="text-white mt-3">Aucun produit</h4>
            <p class="text-white opacity-75">Ajoutez des produits pour g√©n√©rer des codes-barres</p>
            <a href="/ajouter" class="btn btn-light btn-lg">
                <i class="bi bi-plus-circle me-2"></i>Ajouter un produit
            </a>
        </div>
        {% endif %}

        <!-- Zone d'impression cach√©e -->
        <div id="printArea" style="display: none;">
            <!-- Rempli par JavaScript -->
        </div>
    </div>

    <script>
        let currentScale = 1;

        // G√©n√©rer tous les codes-barres au chargement
        document.addEventListener('DOMContentLoaded', function() {
            generateAllBarcodes();
        });

        function generateAllBarcodes() {
            const canvases = document.querySelectorAll('.barcode-canvas');
            canvases.forEach(canvas => {
                const code = canvas.dataset.code;
                const text = canvas.dataset.text;
                
                try {
                    JsBarcode(canvas, code, {
                        format: "CODE128",
                        width: 2 * currentScale,
                        height: 60 * currentScale,
                        displayValue: true,
                        text: `${text}\n${code}`,
                        fontSize: 12 * currentScale,
                        margin: 10
                    });
                } catch (e) {
                    console.error('Erreur g√©n√©ration code-barres:', e);
                }
            });
        }

        function updateBarcodeSize(scale) {
            currentScale = parseFloat(scale);
            generateAllBarcodes();
        }

        function filterCategory(category) {
            // Mettre √† jour les boutons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filtrer les √©l√©ments
            const items = document.querySelectorAll('.barcode-item');
            items.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                    // Animation d'apparition
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        item.style.transition = 'all 0.5s ease';
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    }, 100);
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('.barcode-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                // Ne s√©lectionner que les √©l√©ments visibles
                const item = checkbox.closest('.barcode-item');
                if (item.style.display !== 'none') {
                    checkbox.checked = !allChecked;
                }
            });
            
            // Mettre √† jour le texte du bouton
            const btn = event.target;
            btn.innerHTML = allChecked ? 
                '<i class="bi bi-check-all me-1"></i>Tout s√©lectionner' :
                '<i class="bi bi-x-square me-1"></i>Tout d√©s√©lectionner';
        }

        function printSelected() {
            const selected = document.querySelectorAll('.barcode-checkbox:checked');
            
            if (selected.length === 0) {
                alert('‚ö†Ô∏è S√©lectionnez au moins un code-barres √† imprimer');
                return;
            }

            // Cr√©er la zone d'impression
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';
            
            selected.forEach(checkbox => {
                const item = checkbox.closest('.barcode-item');
                const clone = item.cloneNode(true);
                
                // Nettoyer le clone pour l'impression
                clone.querySelector('.form-check-input').remove();
                clone.classList.add('print-section');
                
                printArea.appendChild(clone);
            });

            // R√©g√©n√©rer les codes-barres dans la zone d'impression
            const printCanvases = printArea.querySelectorAll('.barcode-canvas');
            printCanvases.forEach(canvas => {
                const code = canvas.dataset.code;
                const text = canvas.dataset.text;
                
                JsBarcode(canvas, code, {
                    format: "CODE128",
                    width: 2,
                    height: 60,
                    displayValue: true,
                    text: `${text}\n${code}`,
                    fontSize: 12,
                    margin: 10
                });
            });

            // Imprimer
            printArea.style.display = 'block';
            window.print();
            printArea.style.display = 'none';
        }

        // Animation d'entr√©e
        document.addEventListener('DOMContentLoaded', function() {
            const items = document.querySelectorAll('.barcode-item');
            items.forEach((item, index) => {
                item.style.opacity = '0';
                item.style.transform = 'translateX(-30px)';
                
                setTimeout(() => {
                    item.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>
