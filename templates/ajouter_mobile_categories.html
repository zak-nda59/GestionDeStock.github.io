<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Ajouter Produit - Boutique Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
        }
        .card { 
            border: none; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.95);
        }
        .category-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }
        .product-suggestion {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 5px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .product-suggestion:hover {
            background: #bbdefb;
            transform: translateY(-2px);
        }
        .emoji-large {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .category-option {
            transition: all 0.3s ease;
        }
        .category-option:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header text-center bg-success text-white">
                        <h3><i class="bi bi-plus-circle me-2"></i>üì± Ajouter un Produit</h3>
                        <p class="mb-0">Boutique R√©paration Mobile - Cat√©gories Personnalis√©es</p>
                    </div>
                    <div class="card-body">
                        {% if error %}
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}

                        <form method="POST" id="ajouterForm">
                            <!-- Cat√©gorie (avec vos cat√©gories personnalis√©es) -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-folder me-2"></i>üìÇ Cat√©gorie *
                                </label>
                                <select class="form-select form-select-lg" name="categorie" id="categorie" required onchange="afficherSuggestions()">
                                    <option value="">Choisissez une cat√©gorie...</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.nom }}" data-emoji="{{ cat.emoji }}" data-description="{{ cat.description or '' }}">
                                        {{ cat.emoji }} {{ cat.nom }}
                                        {% if not cat.est_systeme %} (Personnalis√©e){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                
                                <!-- Aper√ßu de la cat√©gorie -->
                                <div id="categoryPreview" class="category-preview">
                                    <div class="text-center">
                                        <div id="categoryEmoji" class="emoji-large"></div>
                                        <h6 id="categoryName"></h6>
                                        <p id="categoryDescription" class="text-muted small"></p>
                                        <div id="categoryType" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Lien vers gestion des cat√©gories -->
                            <div class="mb-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>üí° Astuce :</strong> 
                                    Vous ne trouvez pas la cat√©gorie souhait√©e ? 
                                    <div class="mt-2">
                                        <a href="/categories/creer" class="btn btn-sm btn-success me-2" target="_blank">
                                            <i class="bi bi-plus-circle me-1"></i>Cr√©er une Cat√©gorie
                                        </a>
                                        <a href="/categories" class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="bi bi-folder me-1"></i>G√©rer les Cat√©gories
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Suggestions de produits -->
                            <div id="suggestions" class="mb-4" style="display: none;">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-lightbulb me-2"></i>üí° Suggestions pour cette cat√©gorie
                                </label>
                                <div id="suggestionsList" class="border rounded p-3 bg-light">
                                    <!-- Rempli par JavaScript -->
                                </div>
                                <small class="text-muted">Cliquez sur une suggestion pour pr√©-remplir le nom</small>
                            </div>

                            <!-- Nom du produit -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-tag me-2"></i>üìù Nom du produit *
                                </label>
                                <input type="text" class="form-control form-control-lg" name="nom" id="nom" 
                                       placeholder="Ex: √âcran iPhone 13 Pro Max OLED" required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Soyez pr√©cis : mod√®le, marque, sp√©cifications
                                </div>
                            </div>

                            <!-- Code-barres -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-upc me-2"></i>üè∑Ô∏è Code-barres *
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-lg" name="code_barres" id="code_barres" 
                                           placeholder="Ex: ECR001" required>
                                    <button type="button" class="btn btn-outline-primary" onclick="genererCodeAuto()">
                                        <i class="bi bi-magic me-1"></i>Auto
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Code unique pour identifier le produit
                                </div>
                            </div>

                            <!-- Prix -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-currency-euro me-2"></i>üí∞ Prix (‚Ç¨) *
                                </label>
                                <input type="number" class="form-control form-control-lg" name="prix" 
                                       step="0.01" min="0" placeholder="Ex: 89.99" required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Prix de vente en euros
                                </div>
                            </div>

                            <!-- Stock initial -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-box me-2"></i>üì¶ Stock initial *
                                </label>
                                <input type="number" class="form-control form-control-lg" name="stock" 
                                       min="0" placeholder="Ex: 5" required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Quantit√© disponible en stock
                                </div>
                            </div>

                            <!-- Boutons -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="/" class="btn btn-secondary btn-lg me-md-2">
                                    <i class="bi bi-arrow-left me-2"></i>Annuler
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-plus-circle me-2"></i>Ajouter le Produit
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Aide contextuelle -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6><i class="bi bi-question-circle me-2"></i>üí° Conseils par Cat√©gorie</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üì± √âcrans & üîã Batteries</h6>
                                <ul class="small">
                                    <li>Pr√©cisez : iPhone/Samsung/Xiaomi</li>
                                    <li>Mod√®le exact : 13 Pro Max, S21, etc.</li>
                                    <li>Type : OLED, LCD, AMOLED</li>
                                    <li>Capacit√© en mAh pour batteries</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>üõ°Ô∏è Coques & üëú Housses</h6>
                                <ul class="small">
                                    <li>Mod√®le de t√©l√©phone compatible</li>
                                    <li>Mat√©riau : Silicone, Cuir, etc.</li>
                                    <li>Fonctions : Antichoc, MagSafe</li>
                                    <li>Couleur si pertinent</li>
                                </ul>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>üîå C√¢bles & üîß Outils</h6>
                                <ul class="small">
                                    <li>Type : Lightning, USB-C, Micro-USB</li>
                                    <li>Longueur pour les c√¢bles</li>
                                    <li>Fonction sp√©ciale si applicable</li>
                                    <li>Compatibilit√© charge rapide</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>üìÇ Cat√©gories Personnalis√©es</h6>
                                <ul class="small">
                                    <li>Utilisez vos propres cat√©gories</li>
                                    <li>Cr√©ez de nouvelles cat√©gories si besoin</li>
                                    <li>Organisez selon votre activit√©</li>
                                    <li>Emojis pour identification rapide</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Suggestions par cat√©gorie (extensible avec vos cat√©gories)
        const suggestions = {
            '√âcran': [
                '√âcran iPhone 13 Pro Max OLED',
                '√âcran iPhone 12 LCD',
                '√âcran Samsung Galaxy S21',
                '√âcran iPhone 11 Pro',
                '√âcran Xiaomi Redmi Note 10',
                '√âcran Huawei P30 Pro',
                '√âcran OnePlus 9 Pro'
            ],
            'Batterie': [
                'Batterie iPhone 13 Pro',
                'Batterie iPhone 12 Mini',
                'Batterie Samsung Galaxy S20',
                'Batterie iPhone 11 Pro Max',
                'Batterie Xiaomi Mi 11',
                'Batterie Huawei P40'
            ],
            'Coque': [
                'Coque iPhone 13 Transparente',
                'Coque Samsung S21 Antichoc',
                'Coque iPhone 12 Pro Cuir',
                'Coque Xiaomi Redmi Silicone',
                'Coque iPhone 11 MagSafe'
            ],
            'Housse': [
                'Housse iPhone 13 Pro Max',
                'Housse Samsung Galaxy Tab',
                'Housse Universelle 6.1"',
                'Housse iPhone 12 Portefeuille'
            ],
            'Verre Tremp√©': [
                'Verre Tremp√© iPhone 13 Pro',
                'Verre Tremp√© Samsung S21',
                'Verre Tremp√© iPhone 12 Mini',
                'Verre Tremp√© Xiaomi Redmi',
                'Verre Tremp√© Huawei P30'
            ],
            'C√¢ble': [
                'C√¢ble Lightning iPhone 1m',
                'C√¢ble USB-C Samsung 2m',
                'C√¢ble Micro-USB 1.5m',
                'Chargeur Sans Fil iPhone',
                'Adaptateur Lightning Jack'
            ],
            'Outil': [
                'Kit Tournevis R√©paration',
                'Ventouse D√©montage √âcran',
                'Spatule Plastique x5',
                'Tapis Antistatique'
            ],
            'Accessoire': [
                'Support T√©l√©phone Bureau',
                'Nettoyant √âcran 250ml',
                'Chiffon Microfibre x3',
                'Adh√©sif Double Face √âcran'
            ]
        };

        function afficherSuggestions() {
            const categorieSelect = document.getElementById('categorie');
            const selectedOption = categorieSelect.options[categorieSelect.selectedIndex];
            const categorie = selectedOption.value;
            const preview = document.getElementById('categoryPreview');
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (categorie) {
                // Afficher l'aper√ßu de la cat√©gorie
                const emoji = selectedOption.dataset.emoji || 'üì¶';
                const description = selectedOption.dataset.description || '';
                const isSystem = !selectedOption.text.includes('(Personnalis√©e)');
                
                document.getElementById('categoryEmoji').textContent = emoji;
                document.getElementById('categoryName').textContent = categorie;
                document.getElementById('categoryDescription').textContent = description;
                
                const typeDiv = document.getElementById('categoryType');
                if (isSystem) {
                    typeDiv.innerHTML = '<span class="badge bg-primary">Cat√©gorie Syst√®me</span>';
                } else {
                    typeDiv.innerHTML = '<span class="badge bg-success">Cat√©gorie Personnalis√©e</span>';
                }
                
                preview.style.display = 'block';
                
                // Charger les suggestions dynamiques depuis l'API
                fetch(`/api/suggestions/${encodeURIComponent(categorie)}`)
                    .then(response => response.json())
                    .then(suggestionsDynamiques => {
                        const suggestionsList = document.getElementById('suggestionsList');
                        suggestionsList.innerHTML = '';
                        
                        // Combiner suggestions statiques et dynamiques
                        let toutesLesSuggestions = [];
                        
                        // Ajouter les suggestions statiques si disponibles
                        if (suggestions[categorie]) {
                            toutesLesSuggestions = [...suggestions[categorie]];
                        }
                        
                        // Ajouter les suggestions dynamiques bas√©es sur les produits existants
                        if (suggestionsDynamiques && suggestionsDynamiques.length > 0) {
                            toutesLesSuggestions = [...toutesLesSuggestions, ...suggestionsDynamiques];
                        }
                        
                        // Supprimer les doublons
                        toutesLesSuggestions = [...new Set(toutesLesSuggestions)];
                        
                        if (toutesLesSuggestions.length > 0) {
                            toutesLesSuggestions.forEach(suggestion => {
                                const span = document.createElement('span');
                                span.className = 'product-suggestion';
                                span.textContent = suggestion;
                                span.onclick = () => {
                                    document.getElementById('nom').value = suggestion;
                                    document.getElementById('nom').focus();
                                };
                                suggestionsList.appendChild(span);
                            });
                            
                            // Ajouter un indicateur pour les suggestions dynamiques
                            if (suggestionsDynamiques && suggestionsDynamiques.length > 0) {
                                const info = document.createElement('div');
                                info.className = 'mt-2 text-muted small';
                                info.innerHTML = `<i class="bi bi-magic me-1"></i>Suggestions bas√©es sur vos produits existants`;
                                suggestionsList.appendChild(info);
                            }
                        } else {
                            suggestionsList.innerHTML = `
                                <div class="text-center text-muted">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    Aucune suggestion disponible pour "${categorie}"<br>
                                    <small>Ajoutez des produits dans cette cat√©gorie pour g√©n√©rer des suggestions automatiques !</small>
                                </div>
                            `;
                        }
                        
                        suggestionsDiv.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Erreur chargement suggestions:', error);
                        // Fallback vers suggestions statiques
                        const suggestionsList = document.getElementById('suggestionsList');
                        if (suggestions[categorie]) {
                            suggestionsList.innerHTML = '';
                            suggestions[categorie].forEach(suggestion => {
                                const span = document.createElement('span');
                                span.className = 'product-suggestion';
                                span.textContent = suggestion;
                                span.onclick = () => {
                                    document.getElementById('nom').value = suggestion;
                                    document.getElementById('nom').focus();
                                };
                                suggestionsList.appendChild(span);
                            });
                        } else {
                            suggestionsList.innerHTML = `
                                <div class="text-center text-muted">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    Erreur de chargement des suggestions
                                </div>
                            `;
                        }
                        suggestionsDiv.style.display = 'block';
                    });
            } else {
                preview.style.display = 'none';
                suggestionsDiv.style.display = 'none';
            }
        }

        function genererCodeAuto() {
            const categorieSelect = document.getElementById('categorie');
            const selectedOption = categorieSelect.options[categorieSelect.selectedIndex];
            const categorie = selectedOption.value;
            
            if (!categorie) {
                alert('Veuillez d\'abord choisir une cat√©gorie');
                return;
            }
            
            // Pr√©fixes par cat√©gorie (extensible)
            const prefixes = {
                '√âcran': 'ECR',
                'Batterie': 'BAT',
                'Coque': 'COQ',
                'Housse': 'HOU',
                'Verre Tremp√©': 'VER',
                'C√¢ble': 'CAB',
                'Outil': 'OUT',
                'Accessoire': 'ACC',
                'Autre': 'AUT'
            };
            
            // G√©n√©rer un pr√©fixe bas√© sur le nom de la cat√©gorie si pas dans la liste
            let prefix = prefixes[categorie];
            if (!prefix) {
                // Prendre les 3 premi√®res lettres en majuscules
                prefix = categorie.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, '');
                if (prefix.length < 3) {
                    prefix = prefix.padEnd(3, 'X');
                }
            }
            
            const numero = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
            const code = prefix + numero;
            
            document.getElementById('code_barres').value = code;
        }

        // Auto-focus sur le premier champ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('categorie').focus();
        });

        // Validation du formulaire
        document.getElementById('ajouterForm').addEventListener('submit', function(e) {
            const categorie = document.getElementById('categorie').value;
            const nom = document.getElementById('nom').value.trim();
            const codeBarres = document.getElementById('code_barres').value.trim();
            
            if (!categorie || !nom || !codeBarres) {
                e.preventDefault();
                alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // Confirmation pour cat√©gories personnalis√©es
            const selectedOption = document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex];
            const isPersonnalisee = selectedOption.text.includes('(Personnalis√©e)');
            
            if (isPersonnalisee) {
                if (!confirm(`‚úÖ Vous ajoutez un produit dans la cat√©gorie personnalis√©e "${categorie}".\n\nContinuer ?`)) {
                    e.preventDefault();
                }
            }
        });
    </script>
</body>
</html>
