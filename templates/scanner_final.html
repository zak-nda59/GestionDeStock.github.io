<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Scanner Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .scanner-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .camera-box {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }
        
        #video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        
        .scan-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { transform: translateY(-50px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(50px); opacity: 0; }
        }
        
        .btn-custom {
            border-radius: 15px;
            padding: 12px 25px;
            font-weight: 600;
            margin: 5px;
        }
        
        .modal-custom {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
        }
        
        .modal-content-custom {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .quantity-input {
            font-size: 2rem;
            text-align: center;
            border-radius: 15px;
            border: 3px solid #007bff;
            padding: 15px;
            margin: 20px 0;
            width: 100%;
        }
        
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <!-- Header -->
        <div class="card text-center">
            <h1 class="h3 mb-3">üì± Scanner Final</h1>
            <p class="text-muted">Scanner codes-barres professionnel</p>
            
            <div class="row">
                <div class="col-6">
                    <a href="/" class="btn btn-outline-primary btn-custom w-100">
                        <i class="bi bi-house"></i> Accueil
                    </a>
                </div>
                <div class="col-6">
                    <a href="/produits" class="btn btn-outline-success btn-custom w-100">
                        <i class="bi bi-box-seam"></i> Produits
                    </a>
                </div>
            </div>
        </div>

        <!-- Scanner Cam√©ra -->
        <div class="card">
            <h4 class="text-center mb-3">üì∑ Scanner Cam√©ra</h4>
            
            <div class="camera-box">
                <video id="video" autoplay playsinline muted></video>
                <div class="scan-line"></div>
            </div>
            
            <div class="text-center mt-3">
                <button id="startCamera" class="btn btn-success btn-custom">
                    <i class="bi bi-camera"></i> D√©marrer Cam√©ra
                </button>
                <button id="stopCamera" class="btn btn-danger btn-custom" style="display: none;">
                    <i class="bi bi-stop-circle"></i> Arr√™ter Cam√©ra
                </button>
            </div>
        </div>

        <!-- Scanner Manuel -->
        <div class="card">
            <h4 class="text-center mb-3">‚å®Ô∏è Saisie Manuelle</h4>
            <div class="row">
                <div class="col-8">
                    <input type="text" id="manualCode" class="form-control form-control-lg" 
                           placeholder="Tapez le code-barres..." style="border-radius: 15px;">
                </div>
                <div class="col-4">
                    <button id="manualScan" class="btn btn-primary btn-lg w-100" style="border-radius: 15px;">
                        <i class="bi bi-search"></i> Scan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestion Stock -->
    <div id="stockModal" class="modal-custom">
        <div class="modal-content-custom">
            <h3 id="modalTitle">Gestion du Stock</h3>
            
            <div class="my-4">
                <h4 id="productName">Produit</h4>
                <p id="productDetails" class="text-muted">D√©tails du produit</p>
            </div>
            
            <div class="mb-4">
                <label class="form-label h5">Action :</label>
                <div class="row">
                    <div class="col-6">
                        <button id="addStockBtn" class="btn btn-success btn-lg w-100">
                            <i class="bi bi-plus-circle"></i><br>Ajouter
                        </button>
                    </div>
                    <div class="col-6">
                        <button id="removeStockBtn" class="btn btn-warning btn-lg w-100">
                            <i class="bi bi-dash-circle"></i><br>Retirer
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="quantitySection" style="display: none;">
                <label class="form-label h5">Quantit√© :</label>
                <input type="number" id="quantityInput" class="quantity-input" 
                       value="1" min="1" max="999">
                
                <div class="mt-3">
                    <button id="confirmAction" class="btn btn-primary btn-lg me-2">
                        <i class="bi bi-check-circle"></i> Confirmer
                    </button>
                    <button id="cancelAction" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle"></i> Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    
    <script>
        // Variables globales
        let currentProduct = null;
        let selectedAction = null; // 'add' ou 'remove'
        let isScanning = false;
        let stream = null;

        // √âl√©ments DOM
        const video = document.getElementById('video');
        const startCameraBtn = document.getElementById('startCamera');
        const stopCameraBtn = document.getElementById('stopCamera');
        const manualCodeInput = document.getElementById('manualCode');
        const manualScanBtn = document.getElementById('manualScan');
        const stockModal = document.getElementById('stockModal');
        const modalTitle = document.getElementById('modalTitle');
        const productName = document.getElementById('productName');
        const productDetails = document.getElementById('productDetails');
        const addStockBtn = document.getElementById('addStockBtn');
        const removeStockBtn = document.getElementById('removeStockBtn');
        const quantitySection = document.getElementById('quantitySection');
        const quantityInput = document.getElementById('quantityInput');
        const confirmActionBtn = document.getElementById('confirmAction');
        const cancelActionBtn = document.getElementById('cancelAction');

        // D√©marrer la cam√©ra
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                video.srcObject = stream;
                startCameraBtn.style.display = 'none';
                stopCameraBtn.style.display = 'inline-block';
                
                // Attendre que la vid√©o soit pr√™te
                video.addEventListener('loadedmetadata', () => {
                    setTimeout(initScanner, 1000);
                });
                
            } catch (err) {
                showMessage('Erreur cam√©ra: ' + err.message, 'danger');
            }
        });

        // Arr√™ter la cam√©ra
        stopCameraBtn.addEventListener('click', () => {
            stopScanning();
        });

        function stopScanning() {
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
            }
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
            }
            
            startCameraBtn.style.display = 'inline-block';
            stopCameraBtn.style.display = 'none';
        }

        // Initialiser le scanner
        function initScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: video,
                    constraints: {
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 },
                        facingMode: "environment"
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: false
                },
                numOfWorkers: navigator.hardwareConcurrency || 4,
                frequency: 10,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader", 
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Erreur Quagga:', err);
                    showMessage('Erreur scanner: ' + err.message, 'danger');
                    return;
                }
                
                Quagga.start();
                isScanning = true;
                showMessage('Scanner d√©marr√© avec succ√®s', 'success');
            });

            // √âv√©nement de d√©tection
            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                
                // V√©rifier la qualit√© du scan
                if (data.codeResult.decodedCodes) {
                    const avgError = data.codeResult.decodedCodes.reduce((sum, x) => sum + (x.error || 0), 0) / data.codeResult.decodedCodes.length;
                    if (avgError > 0.2) {
                        return; // Ignorer les scans de mauvaise qualit√©
                    }
                }
                
                console.log('Code d√©tect√©:', code);
                
                // Vibration
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                // Pause temporaire pour √©viter les scans multiples
                Quagga.pause();
                
                // Rechercher le produit
                searchProduct(code);
                
                // Reprendre apr√®s 3 secondes
                setTimeout(() => {
                    if (isScanning) {
                        Quagga.start();
                    }
                }, 3000);
            });
        }

        // Scanner manuel
        manualScanBtn.addEventListener('click', () => {
            const code = manualCodeInput.value.trim();
            if (code) {
                searchProduct(code);
                manualCodeInput.value = '';
            } else {
                showMessage('Veuillez saisir un code-barres', 'warning');
            }
        });

        // Entr√©e sur le champ manuel
        manualCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const code = manualCodeInput.value.trim();
                if (code) {
                    searchProduct(code);
                    manualCodeInput.value = '';
                }
            }
        });

        // Rechercher un produit
        async function searchProduct(barcode) {
            try {
                showMessage('Recherche du produit...', 'info');
                
                const response = await fetch('/api/scan-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code_barres: barcode })
                });

                const result = await response.json();
                
                if (result.success && result.produit) {
                    currentProduct = result.produit;
                    showStockModal(result.produit);
                } else {
                    showMessage('Produit non trouv√©: ' + barcode, 'warning');
                }
            } catch (error) {
                showMessage('Erreur de recherche: ' + error.message, 'danger');
            }
        }

        // Afficher le modal de gestion stock
        function showStockModal(product) {
            modalTitle.textContent = 'Produit trouv√© !';
            productName.textContent = product.nom;
            productDetails.innerHTML = `
                <strong>Code:</strong> ${product.code_barres}<br>
                <strong>Prix:</strong> ${product.prix}‚Ç¨<br>
                <strong>Stock actuel:</strong> ${product.stock}<br>
                <strong>Cat√©gorie:</strong> ${product.categorie}
            `;
            
            // R√©initialiser l'interface
            quantitySection.style.display = 'none';
            selectedAction = null;
            quantityInput.value = 1;
            
            stockModal.style.display = 'block';
        }

        // S√©lection d'action
        addStockBtn.addEventListener('click', () => {
            selectedAction = 'add';
            modalTitle.textContent = 'Ajouter du Stock';
            quantitySection.style.display = 'block';
            quantityInput.focus();
        });

        removeStockBtn.addEventListener('click', () => {
            selectedAction = 'remove';
            modalTitle.textContent = 'Retirer du Stock';
            quantitySection.style.display = 'block';
            quantityInput.focus();
        });

        // Confirmer l'action
        confirmActionBtn.addEventListener('click', async () => {
            const quantity = parseInt(quantityInput.value);
            
            if (!quantity || quantity < 1) {
                showMessage('Quantit√© invalide', 'warning');
                return;
            }

            if (!selectedAction || !currentProduct) {
                showMessage('Erreur de configuration', 'danger');
                return;
            }

            try {
                showMessage('Mise √† jour du stock...', 'info');
                
                const response = await fetch('/api/ajuster-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        produit_id: currentProduct.id,
                        action: selectedAction,
                        quantite: quantity
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const actionText = selectedAction === 'add' ? 'ajout√©' : 'retir√©';
                    showMessage(`Stock ${actionText} avec succ√®s! Nouveau stock: ${result.nouveau_stock}`, 'success');
                    closeModal();
                } else {
                    showMessage('Erreur: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('Erreur: ' + error.message, 'danger');
            }
        });

        // Annuler l'action
        cancelActionBtn.addEventListener('click', () => {
            closeModal();
        });

        // Fermer le modal
        function closeModal() {
            stockModal.style.display = 'none';
            currentProduct = null;
            selectedAction = null;
        }

        // Fermer modal en cliquant √† l'ext√©rieur
        stockModal.addEventListener('click', (e) => {
            if (e.target === stockModal) {
                closeModal();
            }
        });

        // Afficher un message
        function showMessage(message, type = 'info') {
            // Supprimer les anciens messages
            const oldMessages = document.querySelectorAll('.status-message');
            oldMessages.forEach(msg => msg.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} status-message`;
            alertDiv.innerHTML = `
                <i class="bi bi-${getIcon(type)}"></i> ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-supprimer apr√®s 5 secondes
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function getIcon(type) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-circle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Gestion des touches
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && stockModal.style.display === 'block') {
                closeModal();
            }
        });

        console.log('Scanner Final initialis√© avec succ√®s');
    </script>
</body>
</html>
