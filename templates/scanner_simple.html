<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Ultra-Permissif - Gestion Inventaire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
        }
        .card { 
            border: none; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.95);
        }
        .viewport {
            width: 100%;
            height: 300px;
            border: 3px dashed #28a745;
            border-radius: 10px;
            background: #000;
            position: relative;
            overflow: hidden;
        }
        .viewport canvas, .viewport video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header text-center bg-success text-white">
                        <h3><i class="bi bi-upc-scan me-2"></i>Scanner Ultra-Permissif</h3>
                        <p class="mb-0">Scanne TOUT - Aucune restriction de qualit√©</p>
                    </div>
                    <div class="card-body">
                        <!-- Saisie manuelle / Douchette -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-upc-scan me-2"></i>Scanner Code-barres (D√©cr√©ment Automatique -1)
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" 
                                       id="codeBarres" 
                                       placeholder="Scannez avec douchette ou tapez le code..." 
                                       autofocus>
                                <button class="btn btn-danger btn-lg" onclick="scanner()">
                                    <i class="bi bi-dash-circle me-1"></i> -1 Stock
                                </button>
                            </div>
                        </div>

                        <!-- Scanner Cam√©ra Ultra-Permissif -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label mb-0">Scanner Ultra-Permissif</label>
                                <div>
                                    <button id="startCamera" class="btn btn-success btn-sm me-2">
                                        <i class="bi bi-camera-video me-1"></i>D√©marrer
                                    </button>
                                    <button id="stopCamera" class="btn btn-danger btn-sm" style="display: none;">
                                        <i class="bi bi-camera-video-off me-1"></i>Arr√™ter
                                    </button>
                                </div>
                            </div>
                            <div id="scanner-container" style="display: none;">
                                <div id="interactive" class="viewport"></div>
                                <div class="text-center mt-2">
                                    <div class="alert alert-success">
                                        <strong>üéØ MODE ULTRA-PERMISSIF ACTIV√â</strong><br>
                                        <small>Scanne TOUTE d√©tection - Qualit√© ignor√©e</small>
                                    </div>
                                    <div id="detection-status" class="mt-2" style="display: none;">
                                        <span class="badge bg-info">üîç Pr√™t...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="resultat"></div>
                        
                        <!-- Instructions -->
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle me-2"></i>Mode Ultra-Permissif</h6>
                            <p class="mb-2">Ce scanner accepte <strong>TOUTE</strong> d√©tection de code-barres, m√™me de tr√®s mauvaise qualit√©.</p>
                            <ul class="mb-0">
                                <li>‚úÖ Aucune restriction de qualit√©</li>
                                <li>‚úÖ Scan instantan√© d√®s d√©tection</li>
                                <li>‚úÖ Optimis√© pour cam√©ras de faible qualit√©</li>
                                <li>‚ö†Ô∏è Peut scanner des codes partiels</li>
                            </ul>
                        </div>

                        <div class="text-center mt-4">
                            <a href="/" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Retour
                            </a>
                            <a href="/scanner" class="btn btn-info ms-2">
                                <i class="bi bi-upc-scan me-2"></i>Scanner Normal
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isScanning = false;
        let lastScannedCode = '';
        let lastScanTime = 0;
        let isProcessing = false;

        document.getElementById('codeBarres').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scanner();
            }
        });

        document.getElementById('startCamera').addEventListener('click', startCamera);
        document.getElementById('stopCamera').addEventListener('click', stopCamera);

        function scanner() {
            const code = document.getElementById('codeBarres').value.trim();
            if (!code) return;
            processScannedCode(code);
        }

        function processScannedCode(code) {
            const currentTime = Date.now();
            const timeDiff = currentTime - lastScanTime;
            
            if (code === lastScannedCode && timeDiff < 2000) {
                console.log('üö´ SCAN IGNOR√â - M√™me code trop r√©cent');
                return;
            }
            
            if (isProcessing) {
                console.log('üö´ SCAN IGNOR√â - Traitement en cours');
                return;
            }
            
            isProcessing = true;
            lastScannedCode = code;
            lastScanTime = currentTime;
            
            console.log('üîç Code scann√©:', code);
            
            fetch('/api/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code_barres: code})
            })
            .then(response => response.json())
            .then(data => {
                afficherResultat(data);
                document.getElementById('codeBarres').value = '';
                document.getElementById('codeBarres').focus();
            })
            .catch(error => {
                console.error('‚ùå Erreur:', error);
                afficherResultat({success: false, message: 'Erreur de connexion'});
            })
            .finally(() => {
                setTimeout(() => {
                    isProcessing = false;
                }, 1000);
            });
        }

        function afficherResultat(data) {
            const resultat = document.getElementById('resultat');
            let alertClass = data.success ? 'alert-success' : 'alert-danger';
            let icon = data.success ? 'bi-check-circle' : 'bi-x-circle';
            
            resultat.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show">
                    <i class="bi ${icon} me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            if (data.success) {
                setTimeout(() => {
                    const alert = resultat.querySelector('.alert');
                    if (alert) {
                        alert.classList.remove('show');
                        setTimeout(() => alert.remove(), 150);
                    }
                }, 4000);
            }
        }

        function startCamera() {
            if (isScanning) return;

            document.getElementById('scanner-container').style.display = 'block';
            document.getElementById('startCamera').style.display = 'none';
            document.getElementById('stopCamera').style.display = 'inline-block';
            isScanning = true;

            // Configuration ULTRA-PERMISSIVE
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 15,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader", 
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Erreur Quagga:', err);
                    afficherResultat({success: false, message: 'Erreur cam√©ra: ' + err.message});
                    stopCamera();
                    return;
                }
                Quagga.start();
                console.log('Scanner ultra-permissif d√©marr√©');
            });

            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                const quality = data.codeResult.quality || 0;
                
                console.log('üì∑ D√âTECTION ULTRA-PERMISSIVE:', code, 'Qualit√©:', quality);
                
                const statusDiv = document.getElementById('detection-status');
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `<span class="badge bg-success">üéØ SCANN√â: ${code}</span>`;
                
                // ACCEPTER ABSOLUMENT TOUT
                if (!code || code.length < 1) {
                    console.log('üö´ Code vide');
                    return;
                }
                
                // Scanner imm√©diatement sans aucune v√©rification de qualit√©
                console.log('‚úÖ SCAN ULTRA-PERMISSIF ACCEPT√â:', code);
                
                Quagga.stop();
                processScannedCode(code);
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 2000);
                
                setTimeout(() => {
                    if (isScanning) {
                        Quagga.start();
                    }
                }, 2000);
            });
        }

        function stopCamera() {
            if (!isScanning) return;

            Quagga.stop();
            document.getElementById('scanner-container').style.display = 'none';
            document.getElementById('startCamera').style.display = 'inline-block';
            document.getElementById('stopCamera').style.display = 'none';
            isScanning = false;
            console.log('Scanner arr√™t√©');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('codeBarres').focus();
        });
    </script>
</body>
</html>
