<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📱 Boutique Réparation Mobile - Inventaire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
        }
        .card { 
            border: none; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.95);
        }
        .category-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .stock-badge {
            font-weight: bold;
        }
        .filters-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }
        .category-stats {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-left: 4px solid #007bff;
        }
        .product-row:hover {
            background-color: rgba(0,123,255,0.1);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        .emoji-category {
            font-size: 1.2em;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- En-tête -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-center bg-primary text-white">
                        <h2><i class="bi bi-phone me-2"></i>📱 Boutique Réparation Mobile</h2>
                        <p class="mb-0">Gestion d'inventaire spécialisée</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques rapides par catégorie -->
        <div class="row mb-4">
            {% for stat in stats_categories %}
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card category-stats">
                    <div class="card-body text-center">
                        <div class="emoji-category">
                            {% if stat.categorie == 'Écran' %}📱
                            {% elif stat.categorie == 'Batterie' %}🔋
                            {% elif stat.categorie == 'Coque' %}🛡️
                            {% elif stat.categorie == 'Housse' %}👜
                            {% elif stat.categorie == 'Verre Trempé' %}🔍
                            {% elif stat.categorie == 'Câble' %}🔌
                            {% elif stat.categorie == 'Outil' %}🔧
                            {% elif stat.categorie == 'Accessoire' %}📎
                            {% else %}📦{% endif %}
                        </div>
                        <h6 class="card-title">{{ stat.categorie }}</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Produits</small>
                                <div class="fw-bold text-primary">{{ stat.total }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stock</small>
                                <div class="fw-bold text-success">{{ stat.stock_total or 0 }}</div>
                            </div>
                        </div>
                        {% if stat.ruptures > 0 %}
                        <div class="mt-2">
                            <span class="badge bg-danger">{{ stat.ruptures }} ruptures</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Filtres et contrôles -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card filters-card">
                    <div class="card-body">
                        <form method="GET" class="row g-3">
                            <!-- Recherche -->
                            <div class="col-md-3">
                                <label class="form-label">🔍 Recherche</label>
                                <input type="text" class="form-control" name="recherche" 
                                       value="{{ recherche_actuelle }}" 
                                       placeholder="Nom ou code-barres...">
                            </div>
                            
                            <!-- Catégorie -->
                            <div class="col-md-3">
                                <label class="form-label">📂 Catégorie</label>
                                <select class="form-select" name="categorie">
                                    <option value="toutes" {% if categorie_actuelle == 'toutes' %}selected{% endif %}>
                                        📦 Toutes les catégories
                                    </option>
                                    {% for cat in categories %}
                                    <option value="{{ cat }}" {% if categorie_actuelle == cat %}selected{% endif %}>
                                        {% if cat == 'Écran' %}📱
                                        {% elif cat == 'Batterie' %}🔋
                                        {% elif cat == 'Coque' %}🛡️
                                        {% elif cat == 'Housse' %}👜
                                        {% elif cat == 'Verre Trempé' %}🔍
                                        {% elif cat == 'Câble' %}🔌
                                        {% elif cat == 'Outil' %}🔧
                                        {% elif cat == 'Accessoire' %}📎
                                        {% else %}📦{% endif %} {{ cat }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Tri -->
                            <div class="col-md-3">
                                <label class="form-label">🔄 Trier par</label>
                                <select class="form-select" name="tri">
                                    <option value="nom_asc" {% if tri_actuel == 'nom_asc' %}selected{% endif %}>
                                        📝 Nom (A → Z)
                                    </option>
                                    <option value="nom_desc" {% if tri_actuel == 'nom_desc' %}selected{% endif %}>
                                        📝 Nom (Z → A)
                                    </option>
                                    <option value="prix_asc" {% if tri_actuel == 'prix_asc' %}selected{% endif %}>
                                        💰 Prix (+ petit → + grand)
                                    </option>
                                    <option value="prix_desc" {% if tri_actuel == 'prix_desc' %}selected{% endif %}>
                                        💰 Prix (+ grand → + petit)
                                    </option>
                                    <option value="stock_asc" {% if tri_actuel == 'stock_asc' %}selected{% endif %}>
                                        📦 Stock (+ petit → + grand)
                                    </option>
                                    <option value="stock_desc" {% if tri_actuel == 'stock_desc' %}selected{% endif %}>
                                        📦 Stock (+ grand → + petit)
                                    </option>
                                    <option value="categorie_asc" {% if tri_actuel == 'categorie_asc' %}selected{% endif %}>
                                        📂 Par catégorie
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Boutons -->
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-funnel me-1"></i>Filtrer
                                </button>
                                <a href="/" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <a href="/ajouter" class="btn btn-success w-100">
                                    <i class="bi bi-plus-circle me-1"></i>Ajouter
                                </a>
                            </div>
                            <div class="col-md-2">
                                <a href="/scanner" class="btn btn-warning w-100">
                                    <i class="bi bi-upc-scan me-1"></i>Scanner
                                </a>
                            </div>
                            <div class="col-md-2">
                                <a href="/codes-barres" class="btn btn-info w-100">
                                    <i class="bi bi-upc me-1"></i>Codes-barres
                                </a>
                            </div>
                            <div class="col-md-2">
                                <a href="/statistiques" class="btn btn-primary w-100">
                                    <i class="bi bi-graph-up me-1"></i>Stats
                                </a>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-success w-100" onclick="exportCSV()">
                                    <i class="bi bi-download me-1"></i>Export
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-info w-100" onclick="imprimerListe()">
                                    <i class="bi bi-printer me-1"></i>Imprimer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des produits -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list me-2"></i>Liste des Produits ({{ produits|length }})</h5>
                    </div>
                    <div class="card-body p-0">
                        {% if produits %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>📂 Catégorie</th>
                                        <th>📝 Nom</th>
                                        <th>🏷️ Code-barres</th>
                                        <th>💰 Prix</th>
                                        <th>📦 Stock</th>
                                        <th>📊 Statut</th>
                                        <th>⚙️ Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for produit in produits %}
                                    <tr class="product-row">
                                        <td>
                                            <span class="badge category-badge
                                                {% if produit.categorie == 'Écran' %}bg-primary
                                                {% elif produit.categorie == 'Batterie' %}bg-success
                                                {% elif produit.categorie == 'Coque' %}bg-info
                                                {% elif produit.categorie == 'Housse' %}bg-warning
                                                {% elif produit.categorie == 'Verre Trempé' %}bg-secondary
                                                {% elif produit.categorie == 'Câble' %}bg-dark
                                                {% elif produit.categorie == 'Outil' %}bg-danger
                                                {% elif produit.categorie == 'Accessoire' %}bg-light text-dark
                                                {% else %}bg-secondary{% endif %}">
                                                {% if produit.categorie == 'Écran' %}📱
                                                {% elif produit.categorie == 'Batterie' %}🔋
                                                {% elif produit.categorie == 'Coque' %}🛡️
                                                {% elif produit.categorie == 'Housse' %}👜
                                                {% elif produit.categorie == 'Verre Trempé' %}🔍
                                                {% elif produit.categorie == 'Câble' %}🔌
                                                {% elif produit.categorie == 'Outil' %}🔧
                                                {% elif produit.categorie == 'Accessoire' %}📎
                                                {% else %}📦{% endif %} {{ produit.categorie }}
                                            </span>
                                        </td>
                                        <td class="fw-bold">{{ produit.nom }}</td>
                                        <td>
                                            <code>{{ produit.code_barres }}</code>
                                        </td>
                                        <td class="text-success fw-bold">{{ "%.2f"|format(produit.prix) }}€</td>
                                        <td>
                                            <span class="badge stock-badge
                                                {% if produit.stock == 0 %}bg-danger
                                                {% elif produit.stock <= 2 %}bg-warning
                                                {% elif produit.stock <= 5 %}bg-info
                                                {% else %}bg-success{% endif %}">
                                                {{ produit.stock }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if produit.stock == 0 %}
                                                <span class="badge bg-danger">🚨 Rupture</span>
                                            {% elif produit.stock <= 2 %}
                                                <span class="badge bg-warning">⚠️ Critique</span>
                                            {% elif produit.stock <= 5 %}
                                                <span class="badge bg-info">📦 Faible</span>
                                            {% else %}
                                                <span class="badge bg-success">✅ OK</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="/modifier/{{ produit.id }}" class="btn btn-outline-primary">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button class="btn btn-outline-danger" 
                                                        onclick="confirmerSuppression({{ produit.id }}, '{{ produit.nom }}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                <button class="btn btn-outline-info" 
                                                        onclick="scannerProduit('{{ produit.code_barres }}')">
                                                    <i class="bi bi-upc-scan"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <h4 class="text-muted mt-3">Aucun produit trouvé</h4>
                            <p class="text-muted">Modifiez vos filtres ou ajoutez des produits</p>
                            <a href="/ajouter" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>Ajouter un Produit
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function confirmerSuppression(id, nom) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer "${nom}" ?`)) {
                window.location.href = `/supprimer/${id}`;
            }
        }

        function scannerProduit(codeBarres) {
            if (confirm(`Scanner le produit avec le code ${codeBarres} ?`)) {
                fetch('/api/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code_barres: codeBarres})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`✅ ${data.message}`);
                        location.reload();
                    } else {
                        alert(`❌ ${data.message}`);
                    }
                })
                .catch(error => {
                    alert('Erreur de connexion');
                });
            }
        }

        function exportCSV() {
            const table = document.querySelector('table');
            if (!table) {
                alert('Aucune donnée à exporter');
                return;
            }
            
            let csv = 'Catégorie,Nom,Code-barres,Prix,Stock,Statut\n';
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const categorie = cells[0].textContent.trim().replace(/[📱🔋🛡️👜🔍🔌🔧📎📦]/g, '');
                const nom = cells[1].textContent.trim();
                const code = cells[2].textContent.trim();
                const prix = cells[3].textContent.trim();
                const stock = cells[4].textContent.trim();
                const statut = cells[5].textContent.trim().replace(/[🚨⚠️📦✅]/g, '');
                
                csv += `"${categorie}","${nom}","${code}","${prix}","${stock}","${statut}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventaire_mobile_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function imprimerListe() {
            window.print();
        }

        // Auto-refresh toutes les 30 secondes
        setInterval(() => {
            const url = new URL(window.location);
            if (!url.searchParams.has('auto_refresh')) {
                url.searchParams.set('auto_refresh', '1');
                fetch(url.toString())
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const newDoc = parser.parseFromString(html, 'text/html');
                        const newTable = newDoc.querySelector('table tbody');
                        const currentTable = document.querySelector('table tbody');
                        if (newTable && currentTable) {
                            currentTable.innerHTML = newTable.innerHTML;
                        }
                    })
                    .catch(error => console.log('Auto-refresh failed:', error));
            }
        }, 30000);
    </script>

    <style media="print">
        .filters-card, .btn, .card-header { display: none !important; }
        body { background: white !important; }
        .card { box-shadow: none !important; }
    </style>
</body>
</html>
