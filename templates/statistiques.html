{% extends "layout.html" %}

{% block title %}Statistiques - Gestion d'Inventaire{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-graph-up"></i> Statistiques de l'Inventaire</h1>
        <p class="text-muted">Visualisez les données de votre inventaire avec des graphiques interactifs.</p>
    </div>
</div>

<!-- Statistiques générales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ stats.total_produits }}</h3>
                        <p class="mb-0">Produits Total</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-box-seam fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ stats.total_stock }}</h3>
                        <p class="mb-0">Stock Total</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-stack fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ stats.stock_faible }}</h3>
                        <p class="mb-0">Stock Faible</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ stats.rupture_stock }}</h3>
                        <p class="mb-0">Ruptures</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-x-circle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prix moyen -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title"><i class="bi bi-currency-euro"></i> Prix Moyen</h5>
                <h2 class="text-info">{{ "%.2f"|format(stats.prix_moyen) }} €</h2>
                <p class="text-muted">Prix moyen de tous les produits</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title"><i class="bi bi-calculator"></i> Valeur Totale</h5>
                <h2 class="text-success" id="valeurTotale">Calcul en cours...</h2>
                <p class="text-muted">Valeur totale de l'inventaire</p>
            </div>
        </div>
    </div>
</div>

<!-- Graphiques -->
<div class="row">
    <!-- Graphique en barres - Stock par produit -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Stock par Produit</h5>
            </div>
            <div class="card-body">
                <canvas id="stockChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Graphique en secteurs - Répartition du stock -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Répartition du Stock</h5>
            </div>
            <div class="card-body">
                <canvas id="pieChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Graphique linéaire - Valeur par produit -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Valeur par Produit</h5>
            </div>
            <div class="card-body">
                <canvas id="valueChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Graphique en aires - Statut des stocks -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Statut des Stocks</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tableau détaillé -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Détails par Produit</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Produit</th>
                                <th>Stock</th>
                                <th>Prix Unitaire</th>
                                <th>Valeur Totale</th>
                                <th>Statut</th>
                                <th>% du Stock Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for produit in produits %}
                            <tr>
                                <td><strong>{{ produit.nom }}</strong></td>
                                <td>
                                    <span class="badge bg-secondary fs-6">{{ produit.stock }}</span>
                                </td>
                                <td>{{ "%.2f"|format(produit.prix) }} €</td>
                                <td class="fw-bold">{{ "%.2f"|format(produit.stock * produit.prix) }} €</td>
                                <td>
                                    {% if produit.stock == 0 %}
                                        <span class="badge bg-danger">Rupture</span>
                                    {% elif produit.stock < 2 %}
                                        <span class="badge bg-warning">Faible</span>
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" 
                                             role="progressbar" 
                                             style="width: {{ (produit.stock / stats.total_stock * 100) if stats.total_stock > 0 else 0 }}%">
                                            {{ "%.1f"|format((produit.stock / stats.total_stock * 100) if stats.total_stock > 0 else 0) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Récupérer les données des produits
    fetch('/api/produits')
        .then(response => response.json())
        .then(data => {
            createCharts(data);
            calculateTotalValue(data);
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données:', error);
        });

    function calculateTotalValue(produits) {
        let totalValue = 0;
        produits.forEach(produit => {
            totalValue += produit.stock * produit.prix;
        });
        document.getElementById('valeurTotale').textContent = totalValue.toFixed(2) + ' €';
    }

    function createCharts(produits) {
        // Préparer les données
        const labels = produits.map(p => p.nom.length > 15 ? p.nom.substring(0, 15) + '...' : p.nom);
        const stocks = produits.map(p => p.stock);
        const prix = produits.map(p => p.prix);
        const valeurs = produits.map(p => p.stock * p.prix);

        // Couleurs pour les graphiques
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];

        // 1. Graphique en barres - Stock par produit
        const stockCtx = document.getElementById('stockChart').getContext('2d');
        new Chart(stockCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Stock',
                    data: stocks,
                    backgroundColor: colors.slice(0, produits.length),
                    borderColor: colors.slice(0, produits.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Quantité en stock par produit'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // 2. Graphique en secteurs - Répartition du stock
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: stocks,
                    backgroundColor: colors.slice(0, produits.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Répartition du stock total'
                    }
                }
            }
        });

        // 3. Graphique linéaire - Valeur par produit
        const valueCtx = document.getElementById('valueChart').getContext('2d');
        new Chart(valueCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Valeur (€)',
                    data: valeurs,
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Valeur totale par produit (Stock × Prix)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(2) + ' €';
                            }
                        }
                    }
                }
            }
        });

        // 4. Graphique en aires - Statut des stocks
        const statusData = {
            disponible: produits.filter(p => p.stock >= 2).length,
            faible: produits.filter(p => p.stock > 0 && p.stock < 2).length,
            rupture: produits.filter(p => p.stock === 0).length
        };

        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Disponible', 'Stock Faible', 'Rupture'],
                datasets: [{
                    data: [statusData.disponible, statusData.faible, statusData.rupture],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Répartition par statut de stock'
                    }
                },
                cutout: '50%'
            }
        });
    }
});
</script>
{% endblock %}
