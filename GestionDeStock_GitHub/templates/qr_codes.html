<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Codes - Gestion d'Inventaire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card { 
            border: none; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        .btn { border-radius: 10px; font-weight: 600; }
        .navbar { background: rgba(255,255,255,0.1) !important; backdrop-filter: blur(20px); }
        .navbar-brand { color: white !important; font-weight: 700; }
        .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 600; }
        .qr-code-card {
            transition: transform 0.2s, box-shadow 0.2s;
            page-break-inside: avoid;
        }
        .qr-code-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .qr-code-img {
            max-width: 100%;
            height: auto;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            background: white;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .qr-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        @media print {
            body { background: white !important; }
            .navbar, .btn-toolbar { display: none !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd !important; }
            .qr-code-card { break-inside: avoid; margin-bottom: 20px; }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .clickable-code {
            cursor: pointer;
            transition: all 0.2s;
        }
        .clickable-code:hover {
            background: #007bff !important;
            color: white !important;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-qr-code-scan me-2"></i>QR Codes Générés
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="bi bi-house me-1"></i>Accueil
                </a>
                <a class="nav-link" href="/scanner">
                    <i class="bi bi-camera me-1"></i>Scanner
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Titre Principal -->
        <div class="text-center mb-4">
            <h1 class="text-white display-6 fw-bold qr-gradient">
                <i class="bi bi-qr-code-scan me-3 pulse-animation"></i>
                QR Codes des Produits
            </h1>
            <p class="text-white-50">Scannez ces QR codes avec votre smartphone ou douchette pour décrémenter le stock</p>
        </div>

        <!-- Actions -->
        <div class="btn-toolbar justify-content-center mb-4" role="toolbar">
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Imprimer Tout
                </button>
                <a href="/scanner" class="btn btn-success">
                    <i class="bi bi-camera me-2"></i>Tester Scanner
                </a>
                <a href="/" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Retour
                </a>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">{{ produits|length }}</h3>
                        <p class="mb-0">QR Codes Générés</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-success">{{ produits|sum(attribute='stock') }}</h3>
                        <p class="mb-0">Stock Total</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-warning">{{ produits|selectattr('stock', 'lt', 5)|list|length }}</h3>
                        <p class="mb-0">Stock Faible</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-danger">{{ produits|selectattr('stock', 'eq', 0)|list|length }}</h3>
                        <p class="mb-0">Ruptures</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Codes -->
        <div class="row g-4">
            {% for produit in produits %}
            <div class="col-lg-6 col-xl-4">
                <div class="card qr-code-card h-100">
                    <div class="card-header text-center bg-gradient" style="background: linear-gradient(45deg, #667eea, #764ba2);">
                        <h5 class="mb-1 text-white fw-bold">{{ produit.nom }}</h5>
                        <small class="text-white-50">ID: {{ produit.id }} | Stock: {{ produit.stock }}</small>
                    </div>
                    <div class="card-body text-center">
                        {% if produit.qr_code_img %}
                            <div class="mb-3">
                                <img src="{{ produit.qr_code_img }}" 
                                     alt="QR Code {{ produit.code_barres }}"
                                     class="qr-code-img">
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Erreur génération QR code
                            </div>
                        {% endif %}
                        
                        <div class="mt-3">
                            <p class="mb-2">
                                <strong>Code:</strong> 
                                <code class="bg-light px-2 py-1 rounded clickable-code" 
                                      onclick="copyToClipboard('{{ produit.code_barres }}')" 
                                      title="Cliquez pour copier le code">{{ produit.code_barres }}</code>
                                <small class="text-muted d-block">Cliquez pour copier</small>
                            </p>
                            <p class="mb-2">
                                <strong>Prix:</strong> 
                                <span class="badge bg-info fs-6">{{ "%.2f"|format(produit.prix) }} €</span>
                            </p>
                            
                            <!-- Statut Stock avec icônes -->
                            {% if produit.stock == 0 %}
                                <span class="badge bg-danger fs-6 pulse-animation">
                                    <i class="bi bi-x-circle me-1"></i>RUPTURE
                                </span>
                            {% elif produit.stock < 5 %}
                                <span class="badge bg-warning fs-6">
                                    <i class="bi bi-exclamation-triangle me-1"></i>STOCK FAIBLE
                                </span>
                            {% else %}
                                <span class="badge bg-success fs-6">
                                    <i class="bi bi-check-circle me-1"></i>EN STOCK
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer text-center bg-light">
                        <small class="text-muted">
                            <i class="bi bi-smartphone me-1"></i>
                            Scannez avec smartphone ou douchette pour -1 stock
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Instructions Détaillées -->
        <div class="mt-5">
            <div class="card">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(45deg, #667eea, #764ba2);">
                    <h5 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i>
                        Comment utiliser ces QR codes ?
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <i class="bi bi-printer display-4 text-primary"></i>
                                <h6 class="mt-2">1. Impression</h6>
                            </div>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-check text-success me-2"></i>Cliquez sur "Imprimer Tout"</li>
                                <li><i class="bi bi-check text-success me-2"></i>Découpez les QR codes</li>
                                <li><i class="bi bi-check text-success me-2"></i>Collez sur vos produits</li>
                                <li><i class="bi bi-check text-success me-2"></i>Format optimisé étiquettes</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <i class="bi bi-smartphone display-4 text-success"></i>
                                <h6 class="mt-2">2. Scan Smartphone</h6>
                            </div>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-check text-success me-2"></i>Ouvrez l'app caméra</li>
                                <li><i class="bi bi-check text-success me-2"></i>Pointez vers le QR code</li>
                                <li><i class="bi bi-check text-success me-2"></i>Ou utilisez notre scanner</li>
                                <li><i class="bi bi-check text-success me-2"></i>Stock décrémenté automatiquement</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <i class="bi bi-upc-scan display-4 text-warning"></i>
                                <h6 class="mt-2">3. Douchette Pro</h6>
                            </div>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-check text-success me-2"></i>Compatible douchettes USB</li>
                                <li><i class="bi bi-check text-success me-2"></i>Compatible Bluetooth</li>
                                <li><i class="bi bi-check text-success me-2"></i>Scan ultra-rapide</li>
                                <li><i class="bi bi-check text-success me-2"></i>Idéal pour inventaires</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="bi bi-lightbulb display-6 text-info"></i>
                            </div>
                            <div class="col-md-11">
                                <h6><strong>Avantages des QR codes :</strong></h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small>
                                            • <strong>Plus rapides</strong> à scanner<br>
                                            • <strong>Plus fiables</strong> (correction d'erreurs)<br>
                                            • <strong>Plus d'informations</strong> stockées
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small>
                                            • <strong>Compatibles smartphones</strong><br>
                                            • <strong>Résistants</strong> aux dégradations<br>
                                            • <strong>Modernes</strong> et professionnels
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Info -->
        <div class="mt-4">
            <div class="alert alert-success">
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill me-3 text-success" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>✅ QR codes générés avec succès !</strong><br>
                        <small>{{ produits|length }} produits traités | Format: QR Code haute résolution | Compatible: Tous scanners et smartphones</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script pour améliorer l'expérience -->
    <script>
        // Optimiser l'impression
        window.addEventListener('beforeprint', function() {
            document.body.classList.add('printing');
        });
        
        window.addEventListener('afterprint', function() {
            document.body.classList.remove('printing');
        });
        
        // Animation d'entrée des cartes avec effet cascade
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.qr-code-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px) scale(0.9)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0) scale(1)';
                }, index * 150);
            });
            
            // Effet de survol amélioré
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
        
        // Fonction de copie du code
        function copyToClipboard(code) {
            navigator.clipboard.writeText(code).then(() => {
                // Créer une notification temporaire
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; opacity: 0; transition: opacity 0.3s; max-width: 300px;';
                notification.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle me-2"></i>
                        <div>
                            <strong>Code copié !</strong><br>
                            <small>Collez-le dans le scanner pour décrémenter le stock</small>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.style.opacity = '1', 100);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }).catch(err => {
                console.error('Erreur copie:', err);
                // Fallback pour les navigateurs qui ne supportent pas clipboard
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                alert('Code copié: ' + code);
            });
        }
    </script>
</body>
</html>
