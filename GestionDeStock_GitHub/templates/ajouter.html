{% extends "layout.html" %}

{% block title %}Ajouter un Produit - Gestion d'Inventaire{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Ajouter un Nouveau Produit</h4>
            </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> {{ error }}
                    </div>
                {% endif %}

                <form method="POST" id="addProductForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nom" class="form-label">
                                    <i class="bi bi-tag"></i> Nom du Produit *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="nom" 
                                       name="nom" 
                                       required 
                                       placeholder="Ex: Coca-Cola 33cl">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="code_barres" class="form-label">
                                    <i class="bi bi-upc"></i> Code-barres *
                                </label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           id="code_barres" 
                                           name="code_barres" 
                                           required 
                                           placeholder="Ex: 5449000000996">
                                    <button type="button" class="btn btn-outline-secondary" id="scanBarcodeBtn">
                                        <i class="bi bi-upc-scan"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    Scannez ou saisissez manuellement le code-barres
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="prix" class="form-label">
                                    <i class="bi bi-currency-euro"></i> Prix Unitaire (€) *
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="prix" 
                                       name="prix" 
                                       step="0.01" 
                                       min="0" 
                                       required 
                                       placeholder="Ex: 1.50">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock" class="form-label">
                                    <i class="bi bi-stack"></i> Stock Initial *
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="stock" 
                                       name="stock" 
                                       min="0" 
                                       required 
                                       placeholder="Ex: 25">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-info-circle"></i> Aperçu du Produit</h6>
                                <div id="productPreview" class="text-muted">
                                    Remplissez les champs pour voir l'aperçu...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Ajouter le Produit
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Zone de scan caméra (masquée par défaut) -->
        <div class="card mt-4" id="scannerCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-camera"></i> Scanner le Code-barres
                    <button type="button" class="btn btn-sm btn-outline-secondary float-end" id="closeScannerBtn">
                        <i class="bi bi-x"></i> Fermer
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <div id="scanner-container">
                    <div id="interactive" class="viewport"></div>
                </div>
                <div class="text-center mt-3">
                    <button id="startScannerBtn" class="btn btn-success">
                        <i class="bi bi-camera-video"></i> Démarrer le Scanner
                    </button>
                    <button id="stopScannerBtn" class="btn btn-danger" style="display: none;">
                        <i class="bi bi-camera-video-off"></i> Arrêter le Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addProductForm');
    const nomInput = document.getElementById('nom');
    const codeBarresInput = document.getElementById('code_barres');
    const prixInput = document.getElementById('prix');
    const stockInput = document.getElementById('stock');
    const productPreview = document.getElementById('productPreview');
    const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
    const scannerCard = document.getElementById('scannerCard');
    const closeScannerBtn = document.getElementById('closeScannerBtn');
    const startScannerBtn = document.getElementById('startScannerBtn');
    const stopScannerBtn = document.getElementById('stopScannerBtn');
    
    let isScanning = false;

    // Mise à jour de l'aperçu en temps réel
    function updatePreview() {
        const nom = nomInput.value.trim();
        const codeBarres = codeBarresInput.value.trim();
        const prix = prixInput.value;
        const stock = stockInput.value;

        if (!nom && !codeBarres && !prix && !stock) {
            productPreview.innerHTML = '<em>Remplissez les champs pour voir l\'aperçu...</em>';
            return;
        }

        let previewHtml = '<div class="row">';
        
        if (nom) {
            previewHtml += `<div class="col-md-6"><strong>Nom:</strong> ${nom}</div>`;
        }
        if (codeBarres) {
            previewHtml += `<div class="col-md-6"><strong>Code-barres:</strong> <code>${codeBarres}</code></div>`;
        }
        if (prix) {
            previewHtml += `<div class="col-md-6"><strong>Prix:</strong> ${prix} €</div>`;
        }
        if (stock) {
            previewHtml += `<div class="col-md-6"><strong>Stock:</strong> ${stock} unités</div>`;
        }
        
        previewHtml += '</div>';
        productPreview.innerHTML = previewHtml;
    }

    // Écouteurs pour la mise à jour de l'aperçu
    [nomInput, codeBarresInput, prixInput, stockInput].forEach(input => {
        input.addEventListener('input', updatePreview);
    });

    // Scanner de code-barres
    scanBarcodeBtn.addEventListener('click', function() {
        scannerCard.style.display = 'block';
        scannerCard.scrollIntoView({ behavior: 'smooth' });
    });

    closeScannerBtn.addEventListener('click', function() {
        stopScanner();
        scannerCard.style.display = 'none';
    });

    startScannerBtn.addEventListener('click', function() {
        startScanner();
    });

    stopScannerBtn.addEventListener('click', function() {
        stopScanner();
    });

    function startScanner() {
        if (isScanning) return;

        startScannerBtn.style.display = 'none';
        stopScannerBtn.style.display = 'inline-block';
        isScanning = true;

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment"
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "code_39_vin_reader",
                    "codabar_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "i2of5_reader"
                ]
            }
        }, function(err) {
            if (err) {
                console.log(err);
                alert('Erreur lors de l\'initialisation de la caméra: ' + err.message);
                stopScanner();
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected(function(data) {
            const code = data.codeResult.code;
            codeBarresInput.value = code;
            updatePreview();
            stopScanner();
            
            // Faire défiler vers le formulaire
            form.scrollIntoView({ behavior: 'smooth' });
            
            // Focus sur le champ suivant
            nomInput.focus();
        });
    }

    function stopScanner() {
        if (!isScanning) return;

        Quagga.stop();
        startScannerBtn.style.display = 'inline-block';
        stopScannerBtn.style.display = 'none';
        isScanning = false;
    }

    // Validation du formulaire
    form.addEventListener('submit', function(e) {
        const prix = parseFloat(prixInput.value);
        const stock = parseInt(stockInput.value);

        if (prix < 0) {
            e.preventDefault();
            alert('Le prix ne peut pas être négatif.');
            prixInput.focus();
            return;
        }

        if (stock < 0) {
            e.preventDefault();
            alert('Le stock ne peut pas être négatif.');
            stockInput.focus();
            return;
        }

        // Confirmation avant ajout
        const confirmation = confirm(
            `Confirmer l'ajout du produit ?\n\n` +
            `Nom: ${nomInput.value}\n` +
            `Code-barres: ${codeBarresInput.value}\n` +
            `Prix: ${prix} €\n` +
            `Stock: ${stock} unités`
        );

        if (!confirmation) {
            e.preventDefault();
        }
    });

    // Auto-focus sur le premier champ
    nomInput.focus();
});
</script>
{% endblock %}
