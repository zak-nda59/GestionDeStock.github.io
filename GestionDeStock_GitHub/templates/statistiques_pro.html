{% extends "layout_pro.html" %}

{% block title %}Statistiques Pro - Gestion d'Inventaire{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="mb-5">
            <h1 class="display-5 fw-bold text-white mb-2">
                <i class="bi bi-graph-up me-3"></i>
                Tableau de Bord Analytics
            </h1>
            <p class="lead text-white-50 mb-0">Analysez vos données d'inventaire avec des visualisations interactives</p>
        </div>
    </div>
</div>

<!-- Statistiques principales avec animations -->
<div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6">
        <div class="card bg-primary text-white border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 class="fw-bold mb-1" data-counter="{{ stats.total_produits }}">0</h2>
                        <p class="mb-0 opacity-75">Produits Total</p>
                        <div class="mt-2">
                            <small class="opacity-75">
                                <i class="bi bi-arrow-up me-1"></i>
                                Catalogue complet
                            </small>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-3 p-3">
                        <i class="bi bi-box-seam display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card bg-success text-white border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 class="fw-bold mb-1" data-counter="{{ stats.total_stock }}">0</h2>
                        <p class="mb-0 opacity-75">Unités en Stock</p>
                        <div class="mt-2">
                            <small class="opacity-75">
                                <i class="bi bi-stack me-1"></i>
                                Inventaire total
                            </small>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-3 p-3">
                        <i class="bi bi-stack display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card bg-warning text-white border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 class="fw-bold mb-1" data-counter="{{ stats.stock_faible }}">0</h2>
                        <p class="mb-0 opacity-75">Alertes Stock</p>
                        <div class="mt-2">
                            <small class="opacity-75">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Nécessite attention
                            </small>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-3 p-3">
                        <i class="bi bi-exclamation-triangle display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card bg-danger text-white border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 class="fw-bold mb-1" data-counter="{{ stats.rupture_stock }}">0</h2>
                        <p class="mb-0 opacity-75">Ruptures</p>
                        <div class="mt-2">
                            <small class="opacity-75">
                                <i class="bi bi-x-circle me-1"></i>
                                Action urgente
                            </small>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-3 p-3">
                        <i class="bi bi-x-circle display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métriques avancées -->
<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-body text-center p-5">
                <div class="bg-info bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                    <i class="bi bi-currency-euro text-white display-6"></i>
                </div>
                <h3 class="fw-bold text-info mb-2" id="prixMoyen">{{ "%.2f"|format(stats.prix_moyen or 0) }} €</h3>
                <p class="text-muted mb-0">Prix Moyen par Produit</p>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar bg-info" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-body text-center p-5">
                <div class="bg-success bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                    <i class="bi bi-calculator text-white display-6"></i>
                </div>
                <h3 class="fw-bold text-success mb-2" id="valeurTotale">Calcul...</h3>
                <p class="text-muted mb-0">Valeur Totale de l'Inventaire</p>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 90%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Graphiques interactifs -->
<div class="row g-4 mb-5">
    <!-- Graphique en barres - Stock par produit -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-header bg-white border-0 py-4">
                <h5 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-bar-chart text-primary me-2"></i>
                    Stock par Produit
                </h5>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <canvas id="stockChart" width="400" height="300"></canvas>
                    <div id="stockChartLoader" class="position-absolute top-50 start-50 translate-middle">
                        <div class="spinner-custom"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphique en secteurs - Répartition du stock -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-header bg-white border-0 py-4">
                <h5 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-pie-chart text-success me-2"></i>
                    Répartition du Stock
                </h5>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <canvas id="pieChart" width="400" height="300"></canvas>
                    <div id="pieChartLoader" class="position-absolute top-50 start-50 translate-middle">
                        <div class="spinner-custom"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <!-- Graphique linéaire - Valeur par produit -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-header bg-white border-0 py-4">
                <h5 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-graph-up text-info me-2"></i>
                    Valeur par Produit
                </h5>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <canvas id="valueChart" width="400" height="300"></canvas>
                    <div id="valueChartLoader" class="position-absolute top-50 start-50 translate-middle">
                        <div class="spinner-custom"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphique en aires - Statut des stocks -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 animate-on-scroll">
            <div class="card-header bg-white border-0 py-4">
                <h5 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-speedometer2 text-warning me-2"></i>
                    Statut des Stocks
                </h5>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                    <div id="statusChartLoader" class="position-absolute top-50 start-50 translate-middle">
                        <div class="spinner-custom"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tableau détaillé avec filtres -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-lg animate-on-scroll">
            <div class="card-header bg-white border-0 py-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0 fw-bold d-flex align-items-center">
                            <i class="bi bi-table text-primary me-2"></i>
                            Analyse Détaillée par Produit
                        </h5>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="">Tous les statuts</option>
                                <option value="disponible">Disponible</option>
                                <option value="faible">Stock faible</option>
                                <option value="rupture">Rupture</option>
                            </select>
                            <input type="text" class="form-control form-control-sm" placeholder="Rechercher..." id="productSearch">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 py-3 ps-4">Produit</th>
                                <th class="border-0 py-3">Stock</th>
                                <th class="border-0 py-3">Prix Unitaire</th>
                                <th class="border-0 py-3">Valeur Totale</th>
                                <th class="border-0 py-3">Statut</th>
                                <th class="border-0 py-3 pe-4">% du Stock Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for produit in produits %}
                            <tr class="product-row animate-on-scroll" 
                                data-status="{% if produit.stock == 0 %}rupture{% elif produit.stock < 2 %}faible{% else %}disponible{% endif %}">
                                <td class="ps-4 py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px;">
                                            <i class="bi bi-box text-white"></i>
                                        </div>
                                        <strong>{{ produit.nom }}</strong>
                                    </div>
                                </td>
                                <td class="py-3">
                                    <span class="badge bg-secondary bg-gradient fs-6 px-3 py-2">{{ produit.stock }}</span>
                                </td>
                                <td class="py-3">{{ "%.2f"|format(produit.prix) }} €</td>
                                <td class="py-3">
                                    <span class="fw-bold text-success">{{ "%.2f"|format(produit.stock * produit.prix) }} €</span>
                                </td>
                                <td class="py-3">
                                    {% if produit.stock == 0 %}
                                        <span class="badge bg-danger bg-gradient px-3 py-2">
                                            <i class="bi bi-x-circle me-1"></i>Rupture
                                        </span>
                                    {% elif produit.stock < 2 %}
                                        <span class="badge bg-warning bg-gradient px-3 py-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Faible
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success bg-gradient px-3 py-2">
                                            <i class="bi bi-check-circle me-1"></i>OK
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="py-3 pe-4">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                            <div class="progress-bar bg-gradient" 
                                                 style="width: {% if stats.total_stock > 0 %}{{ (produit.stock / stats.total_stock * 100)|round(1) }}{% else %}0{% endif %}%">
                                            </div>
                                        </div>
                                        <small class="fw-semibold">{{ "%.1f"|format((produit.stock / stats.total_stock * 100) if stats.total_stock > 0 else 0) }}%</small>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des compteurs
    const counters = document.querySelectorAll('[data-counter]');
    counters.forEach(counter => {
        const target = parseInt(counter.dataset.counter);
        animateCounter(counter, 0, target, 2000);
    });
    
    // Récupérer et afficher les données des graphiques
    fetch('/api/produits')
        .then(response => response.json())
        .then(data => {
            hideLoaders();
            createCharts(data);
            calculateTotalValue(data);
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données:', error);
            hideLoaders();
            NotificationsPro.error('Erreur lors du chargement des graphiques');
        });

    // Filtres du tableau
    setupTableFilters();
});

function hideLoaders() {
    document.querySelectorAll('[id$="Loader"]').forEach(loader => {
        loader.style.display = 'none';
    });
}

function calculateTotalValue(produits) {
    let totalValue = 0;
    produits.forEach(produit => {
        totalValue += produit.stock * produit.prix;
    });
    
    const valueElement = document.getElementById('valeurTotale');
    animateValue(valueElement, 0, totalValue, 2000, value => value.toFixed(2) + ' €');
}

function animateValue(element, start, end, duration, formatter = null) {
    const startTime = performance.now();
    
    function updateValue(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const easeOutCubic = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * easeOutCubic;
        
        element.textContent = formatter ? formatter(current) : Math.floor(current);
        
        if (progress < 1) {
            requestAnimationFrame(updateValue);
        } else {
            element.textContent = formatter ? formatter(end) : end;
        }
    }
    
    requestAnimationFrame(updateValue);
}

function animateCounter(element, start, end, duration) {
    animateValue(element, start, end, duration);
}

function createCharts(produits) {
    // Préparer les données
    const labels = produits.map(p => p.nom.length > 15 ? p.nom.substring(0, 15) + '...' : p.nom);
    const stocks = produits.map(p => p.stock);
    const prix = produits.map(p => p.prix);
    const valeurs = produits.map(p => p.stock * p.prix);

    // Couleurs professionnelles
    const colors = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
        '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
    ];

    // 1. Graphique en barres - Stock par produit
    const stockCtx = document.getElementById('stockChart').getContext('2d');
    new Chart(stockCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Stock',
                data: stocks,
                backgroundColor: colors.slice(0, produits.length).map(color => color + '80'),
                borderColor: colors.slice(0, produits.length),
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Quantité en stock par produit',
                    font: { size: 14, weight: 'bold' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                    grid: { color: 'rgba(0,0,0,0.1)' }
                },
                x: {
                    grid: { display: false }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutCubic'
            }
        }
    });

    // 2. Graphique en secteurs - Répartition du stock
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: stocks,
                backgroundColor: colors.slice(0, produits.length),
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 20, usePointStyle: true }
                },
                title: {
                    display: true,
                    text: 'Répartition du stock total',
                    font: { size: 14, weight: 'bold' }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutCubic'
            }
        }
    });

    // 3. Graphique linéaire - Valeur par produit
    const valueCtx = document.getElementById('valueChart').getContext('2d');
    new Chart(valueCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valeur (€)',
                data: valeurs,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Valeur totale par produit (Stock × Prix)',
                    font: { size: 14, weight: 'bold' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2) + ' €';
                        }
                    },
                    grid: { color: 'rgba(0,0,0,0.1)' }
                },
                x: {
                    grid: { display: false }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutCubic'
            }
        }
    });

    // 4. Graphique en aires - Statut des stocks
    const statusData = {
        disponible: produits.filter(p => p.stock >= 2).length,
        faible: produits.filter(p => p.stock > 0 && p.stock < 2).length,
        rupture: produits.filter(p => p.stock === 0).length
    };

    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Disponible', 'Stock Faible', 'Rupture'],
            datasets: [{
                data: [statusData.disponible, statusData.faible, statusData.rupture],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 20, usePointStyle: true }
                },
                title: {
                    display: true,
                    text: 'Répartition par statut de stock',
                    font: { size: 14, weight: 'bold' }
                }
            },
            cutout: '60%',
            animation: {
                duration: 2000,
                easing: 'easeOutCubic'
            }
        }
    });
}

function setupTableFilters() {
    const statusFilter = document.getElementById('statusFilter');
    const productSearch = document.getElementById('productSearch');
    const rows = document.querySelectorAll('.product-row');

    function filterTable() {
        const statusValue = statusFilter.value;
        const searchValue = productSearch.value.toLowerCase();

        rows.forEach(row => {
            const status = row.dataset.status;
            const text = row.textContent.toLowerCase();
            
            const statusMatch = !statusValue || status === statusValue;
            const textMatch = !searchValue || text.includes(searchValue);
            
            if (statusMatch && textMatch) {
                row.style.display = '';
                row.style.opacity = '1';
            } else {
                row.style.display = 'none';
                row.style.opacity = '0';
            }
        });
    }

    statusFilter.addEventListener('change', filterTable);
    productSearch.addEventListener('input', filterTable);
}
</script>
{% endblock %}
